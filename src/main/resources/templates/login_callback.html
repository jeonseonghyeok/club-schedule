<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¹´ì¹´ì˜¤ ìë™ ë¡œê·¸ì¸/íšŒì›ê°€ì…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #1a1a1a;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            overflow-x: auto;
        }
        #token-info {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ìƒíƒœ</h1>
        <div id="token-info"></div>
    </div>

    <script>
    // JWT ë§Œë£Œ ì—¬ë¶€ ê²€ì‚¬ í•¨ìˆ˜
    function isTokenExpired(token) {
        if (!token) return true;
        try {
            const payloadBase64 = token.split('.')[1];
            const payloadJson = atob(payloadBase64.replace(/-/g, '+').replace(/_/g, '/'));
            const payload = JSON.parse(payloadJson);
            const now = Math.floor(Date.now() / 1000);
            return payload.exp && payload.exp < now;
        } catch (e) {
            return true;
        }
    }

    function kakaoLogin() {
        const REST_API_KEY = 'aa4268b0d218c509562ca2ee74f23d94';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const kakaoAuthUrl =
            'https://kauth.kakao.com/oauth/authorize?' +
            'response_type=code' +
            '&client_id=' + REST_API_KEY +
            '&redirect_uri=' + encodeURIComponent(REDIRECT_URI);

        window.location.href = kakaoAuthUrl;
    }

    function getQueryParam(name) {
        return new URL(window.location.href).searchParams.get(name);
    }
    
    function displayTokens() {
        const accessToken = localStorage.getItem('access_token');
        const idToken = localStorage.getItem('id_token');
        const tokenInfoDiv = document.getElementById('token-info');

        if (accessToken && idToken) {
            let idTokenPayload = {};
            try {
                // ID í† í°ì˜ payload(ë‚´ìš©)ë¥¼ ë””ì½”ë”©í•˜ê³  íŒŒì‹±
                const payloadBase64 = idToken.split('.')[1];
                idTokenPayload = JSON.parse(atob(payloadBase64.replace(/-/g, '+').replace(/_/g, '/')));
            } catch (e) {
                console.error("ID í† í° íŒŒì‹± ì‹¤íŒ¨:", e);
            }

            const expDate = idTokenPayload.exp ? new Date(idTokenPayload.exp * 1000).toLocaleString() : 'ì •ë³´ ì—†ìŒ';
            const userId = idTokenPayload.sub || idTokenPayload.aud || 'ì •ë³´ ì—†ìŒ';

            tokenInfoDiv.innerHTML = `
                <h2>ë¡œê·¸ì¸ ì„±ê³µ! ğŸ‰</h2>
                <p><strong>í† í° ì •ë³´ê°€ ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                <hr>
                
                <h3>ID í† í° ìš”ì•½ ì •ë³´</h3>
                <ul>
                    <li><strong>ì‚¬ìš©ì ID:</strong> ${userId}</li>
                    <li><strong>í† í° ë§Œë£Œ ì‹œê°„:</strong> ${expDate}</li>
                </ul>

                <h3>ì›ë³¸ Access Token</h3>
                <pre>${accessToken}</pre>
                
                <h3>ì›ë³¸ ID Token</h3>
                <pre>${idToken}</pre>
            `;
        } else {
            tokenInfoDiv.innerHTML = '<h2>ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤. ğŸ˜¥</h2><p>ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¡œê·¸ì¸ì„ ì‹œì‘í•˜ì„¸ìš”.</p>';
        }
    }
    
    async function handleKakaoCallback() {
        const code = getQueryParam('code');
        if (code) {
            try {
                const response = await fetch('/login/kakao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                if (response.ok) {
                    const result = await response.json();
                    localStorage.setItem('access_token', result.access_token);
                    localStorage.setItem('id_token', result.id_token);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    alert('ë¡œê·¸ì¸ ì„±ê³µ: í† í°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    displayTokens();
                } else {
                    const error = await response.json();
                    alert(`ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    console.error('ì„œë²„ ì˜¤ë¥˜:', error);
                }
            } catch (err) {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
                console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', err);
            }
        }
    }

    window.onload = async function() {
        const idToken = localStorage.getItem('id_token');
        
        if (!isTokenExpired(idToken)) {
            console.log("ìœ íš¨í•œ í† í°ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ìë™ ë¡œê·¸ì¸ ìƒëµ.");
            displayTokens();
            return;
        }
        
        localStorage.removeItem('access_token');
        localStorage.removeItem('id_token');
        console.log("ë§Œë£Œëœ í† í°ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
        
        const code = getQueryParam('code');
        if (code) {
            await handleKakaoCallback();
        } else {
            kakaoLogin();
        }
    };
    </script>
</body>
</html>